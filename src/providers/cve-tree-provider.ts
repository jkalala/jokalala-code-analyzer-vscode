/**
 * CVE Tree Provider
 *
 * Displays CVE matches and recommendations in the VS Code sidebar.
 * Provides quick access to vulnerability information and one-click fixes.
 */

import * as vscode from 'vscode'
import { CVEMatch, CVEFix } from '../services/cve-service'

type CVETreeItem = CVEGroupItem | CVEMatchItem | CVEFixItem | CVEInfoItem

export class CVETreeProvider implements vscode.TreeDataProvider<CVETreeItem> {
  private _onDidChangeTreeData = new vscode.EventEmitter<CVETreeItem | undefined>()
  readonly onDidChangeTreeData = this._onDidChangeTreeData.event

  private matches: CVEMatch[] = []
  private recommendations: string[] = []
  private isLoading = false
  private errorMessage: string | null = null

  /**
   * Update the CVE matches to display
   */
  updateMatches(matches: CVEMatch[], recommendations: string[]): void {
    this.matches = matches
    this.recommendations = recommendations
    this.errorMessage = null
    this._onDidChangeTreeData.fire(undefined)
  }

  /**
   * Set loading state
   */
  setLoading(loading: boolean): void {
    this.isLoading = loading
    this._onDidChangeTreeData.fire(undefined)
  }

  /**
   * Set error message
   */
  setError(message: string | null): void {
    this.errorMessage = message
    this._onDidChangeTreeData.fire(undefined)
  }

  /**
   * Clear all data
   */
  clear(): void {
    this.matches = []
    this.recommendations = []
    this.errorMessage = null
    this._onDidChangeTreeData.fire(undefined)
  }

  getTreeItem(element: CVETreeItem): vscode.TreeItem {
    return element
  }

  getChildren(element?: CVETreeItem): CVETreeItem[] {
    if (!element) {
      // Root level
      return this.getRootItems()
    }

    if (element instanceof CVEGroupItem) {
      return element.children
    }

    if (element instanceof CVEMatchItem) {
      return this.getCVEMatchChildren(element.match)
    }

    return []
  }

  private getRootItems(): CVETreeItem[] {
    const items: CVETreeItem[] = []

    // Loading state
    if (this.isLoading) {
      items.push(new CVEInfoItem('$(sync~spin) Searching for CVEs...', 'loading'))
      return items
    }

    // Error state
    if (this.errorMessage) {
      items.push(new CVEInfoItem(`$(error) ${this.errorMessage}`, 'error'))
      return items
    }

    // No matches
    if (this.matches.length === 0) {
      items.push(new CVEInfoItem('$(pass) No vulnerabilities detected', 'info'))
      items.push(new CVEInfoItem('Run analysis to detect CVEs', 'hint'))
      return items
    }

    // Group by severity
    const critical = this.matches.filter(m => m.severity === 'CRITICAL')
    const high = this.matches.filter(m => m.severity === 'HIGH')
    const medium = this.matches.filter(m => m.severity === 'MEDIUM')
    const low = this.matches.filter(m => m.severity === 'LOW')

    if (critical.length > 0) {
      items.push(new CVEGroupItem(
        `Critical (${critical.length})`,
        critical.map(m => new CVEMatchItem(m)),
        'critical'
      ))
    }

    if (high.length > 0) {
      items.push(new CVEGroupItem(
        `High (${high.length})`,
        high.map(m => new CVEMatchItem(m)),
        'high'
      ))
    }

    if (medium.length > 0) {
      items.push(new CVEGroupItem(
        `Medium (${medium.length})`,
        medium.map(m => new CVEMatchItem(m)),
        'medium'
      ))
    }

    if (low.length > 0) {
      items.push(new CVEGroupItem(
        `Low (${low.length})`,
        low.map(m => new CVEMatchItem(m)),
        'low'
      ))
    }

    // Recommendations section
    if (this.recommendations.length > 0) {
      items.push(new CVEGroupItem(
        'Recommendations',
        this.recommendations.map(r => new CVEInfoItem(r, 'recommendation')),
        'recommendations'
      ))
    }

    return items
  }

  private getCVEMatchChildren(match: CVEMatch): CVETreeItem[] {
    const items: CVETreeItem[] = []

    // Confidence
    const confidence = Math.round(match.confidence * 100)
    items.push(new CVEInfoItem(`$(dashboard) ${confidence}% confidence`, 'confidence'))

    // OWASP Category
    items.push(new CVEInfoItem(`$(shield) ${match.owaspCategory}`, 'owasp'))

    // Fix available
    if (match.fix) {
      items.push(new CVEFixItem(match.fix, match))
    }

    // References
    if (match.references.length > 0) {
      items.push(new CVEInfoItem(`$(book) ${match.references.length} references`, 'references'))
    }

    return items
  }
}

/**
 * Group item for categorizing CVEs by severity
 */
class CVEGroupItem extends vscode.TreeItem {
  constructor(
    label: string,
    public readonly children: CVETreeItem[],
    public readonly groupType: 'critical' | 'high' | 'medium' | 'low' | 'recommendations'
  ) {
    super(label, vscode.TreeItemCollapsibleState.Expanded)

    const iconMap = {
      critical: new vscode.ThemeIcon('error', new vscode.ThemeColor('errorForeground')),
      high: new vscode.ThemeIcon('warning', new vscode.ThemeColor('editorWarning.foreground')),
      medium: new vscode.ThemeIcon('info', new vscode.ThemeColor('editorInfo.foreground')),
      low: new vscode.ThemeIcon('circle-outline'),
      recommendations: new vscode.ThemeIcon('lightbulb')
    }

    this.iconPath = iconMap[groupType]
    this.contextValue = `cveGroup-${groupType}`
  }
}

/**
 * Tree item representing a CVE match
 */
class CVEMatchItem extends vscode.TreeItem {
  constructor(public readonly match: CVEMatch) {
    super(match.title, vscode.TreeItemCollapsibleState.Collapsed)

    this.description = match.cveId
    this.tooltip = new vscode.MarkdownString(
      `**${match.title}**\n\n` +
      `${match.description}\n\n` +
      `- Severity: ${match.severity}\n` +
      `- OWASP: ${match.owaspCategory}\n` +
      `- Confidence: ${Math.round(match.confidence * 100)}%`
    )

    const severityIcon = {
      CRITICAL: new vscode.ThemeIcon('flame', new vscode.ThemeColor('errorForeground')),
      HIGH: new vscode.ThemeIcon('alert', new vscode.ThemeColor('editorWarning.foreground')),
      MEDIUM: new vscode.ThemeIcon('warning', new vscode.ThemeColor('editorInfo.foreground')),
      LOW: new vscode.ThemeIcon('info')
    }

    this.iconPath = severityIcon[match.severity]
    this.contextValue = 'cveMatch'

    // Command to show details
    this.command = {
      command: 'jokalala.showCVEDetails',
      title: 'Show CVE Details',
      arguments: [match]
    }
  }
}

/**
 * Tree item representing an available fix
 */
class CVEFixItem extends vscode.TreeItem {
  constructor(
    public readonly fix: CVEFix,
    public readonly match: CVEMatch
  ) {
    super(`Fix: ${fix.description}`, vscode.TreeItemCollapsibleState.None)

    this.description = fix.language
    this.tooltip = new vscode.MarkdownString(
      `**Apply Fix**\n\n` +
      `${fix.description}\n\n` +
      `Language: ${fix.language}\n\n` +
      `Click to apply this fix automatically.`
    )

    this.iconPath = new vscode.ThemeIcon('wrench', new vscode.ThemeColor('terminal.ansiGreen'))
    this.contextValue = 'cveFix'

    // Command to apply fix
    this.command = {
      command: 'jokalala.applyCVEFix',
      title: 'Apply CVE Fix',
      arguments: [fix, match]
    }
  }
}

/**
 * Generic info item for displaying various information
 */
class CVEInfoItem extends vscode.TreeItem {
  constructor(
    label: string,
    public readonly infoType: 'loading' | 'error' | 'info' | 'hint' | 'confidence' | 'owasp' | 'references' | 'recommendation'
  ) {
    super(label, vscode.TreeItemCollapsibleState.None)

    const iconMap: Record<string, vscode.ThemeIcon> = {
      loading: new vscode.ThemeIcon('sync~spin'),
      error: new vscode.ThemeIcon('error', new vscode.ThemeColor('errorForeground')),
      info: new vscode.ThemeIcon('check', new vscode.ThemeColor('terminal.ansiGreen')),
      hint: new vscode.ThemeIcon('lightbulb'),
      confidence: new vscode.ThemeIcon('dashboard'),
      owasp: new vscode.ThemeIcon('shield'),
      references: new vscode.ThemeIcon('book'),
      recommendation: new vscode.ThemeIcon('lightbulb-autofix')
    }

    const icon = iconMap[infoType]
    if (icon) {
      this.iconPath = icon
    }
    this.contextValue = `cveInfo-${infoType}`
  }
}

/**
 * Register CVE tree view and related commands
 */
export function registerCVETreeView(
  context: vscode.ExtensionContext,
  provider: CVETreeProvider
): vscode.TreeView<CVETreeItem> {
  const treeView = vscode.window.createTreeView('jokalala-cve', {
    treeDataProvider: provider,
    showCollapseAll: true
  })

  context.subscriptions.push(treeView)

  return treeView
}
